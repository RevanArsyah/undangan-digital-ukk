---
import Layout from "../../layouts/Layout.astro";
import { Lock, Loader2, CheckCircle } from "lucide-react";
---

<Layout title="Reset Password">
  <div class="flex min-h-screen w-full items-center justify-center bg-slate-50 px-4 dark:bg-slate-900">
    <div class="w-full max-w-md space-y-8 rounded-2xl bg-white p-10 shadow-xl dark:bg-slate-800">
      <div class="text-center">
        <h1 class="font-serif text-3xl font-bold italic text-slate-900 dark:text-white">
          Reset Your Password
        </h1>
        <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
          Enter your new password below
        </p>
      </div>

      <div id="message-container"></div>

      <form id="reset-form" class="mt-8 space-y-6">
        <div>
          <label class="mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300">
            New Password
          </label>
          <input
            type="password"
            id="password"
            required
            minlength="6"
            class="block w-full rounded-lg border border-slate-300 bg-slate-50 py-3 px-4 text-slate-900 placeholder-slate-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white dark:placeholder-slate-500"
            placeholder="Enter new password (min 6 characters)"
          />
        </div>

        <div>
          <label class="mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300">
            Confirm Password
          </label>
          <input
            type="password"
            id="confirm-password"
            required
            minlength="6"
            class="block w-full rounded-lg border border-slate-300 bg-slate-50 py-3 px-4 text-slate-900 placeholder-slate-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white dark:placeholder-slate-500"
            placeholder="Confirm new password"
          />
        </div>

        <button
          type="submit"
          id="submit-btn"
          class="flex w-full items-center justify-center gap-2 rounded-lg bg-slate-900 px-4 py-3 text-sm font-bold text-white transition-colors hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-blue-600 dark:hover:bg-blue-700"
        >
          <Lock class="h-4 w-4" />
          Reset Password
        </button>
      </form>

      <div class="text-center">
        <a href="/admin" class="text-sm text-blue-600 hover:underline dark:text-blue-400">
          Back to login
        </a>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("reset-form") as HTMLFormElement;
    const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
    const messageContainer = document.getElementById("message-container") as HTMLDivElement;
    const passwordInput = document.getElementById("password") as HTMLInputElement;
    const confirmPasswordInput = document.getElementById("confirm-password") as HTMLInputElement;

    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");

    if (!token) {
      messageContainer.innerHTML = `
        <div class="rounded-lg bg-red-50 p-4 text-sm text-red-600 dark:bg-red-900/20 dark:text-red-400">
          Invalid reset link. Please request a new password reset.
        </div>
      `;
      form.style.display = "none";
    }

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      if (password !== confirmPassword) {
        messageContainer.innerHTML = `
          <div class="rounded-lg bg-red-50 p-4 text-sm text-red-600 dark:bg-red-900/20 dark:text-red-400">
            Passwords do not match!
          </div>
        `;
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Resetting...';

      try {
        const res = await fetch("/api/auth/reset-password", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, newPassword: password }),
        });

        const data = await res.json();

        if (res.ok) {
          messageContainer.innerHTML = `
            <div class="rounded-lg bg-green-50 p-4 text-sm text-green-600 dark:bg-green-900/20 dark:text-green-400">
              âœ“ Password reset successfully! Redirecting to login...
            </div>
          `;
          form.style.display = "none";
          setTimeout(() => {
            window.location.href = "/admin";
          }, 2000);
        } else {
          messageContainer.innerHTML = `
            <div class="rounded-lg bg-red-50 p-4 text-sm text-red-600 dark:bg-red-900/20 dark:text-red-400">
              ${data.error || "Failed to reset password"}
            </div>
          `;
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> Reset Password';
        }
      } catch (err) {
        messageContainer.innerHTML = `
          <div class="rounded-lg bg-red-50 p-4 text-sm text-red-600 dark:bg-red-900/20 dark:text-red-400">
            Network error. Please try again.
          </div>
        `;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> Reset Password';
      }
    });
  </script>
</Layout>
