---
import Layout from "../layouts/Layout.astro";
import db from "../lib/db";
import AdminDashboard from "../components/Admin/AdminDashboard";
import UserManagement from "../components/Admin/UserManagement";
import LoginForm from "../components/Admin/LoginForm";
import GuestListManager from "../components/admin/GuestListManager";
import GuestAnalytics from "../components/admin/GuestAnalytics";
import BatchQRGenerator from "../components/admin/BatchQRGenerator";
import { LogOut, CheckCircle2, XCircle, HelpCircle, Users } from "lucide-react";
import { findUserById } from "../lib/auth";
import type { AuthSession } from "../types";

const COOKIE_NAME = "wedding_admin_session";

// Verify session
let isAuthenticated = false;
let currentUser: any = null;

const sessionCookie = Astro.cookies.get(COOKIE_NAME)?.value;
if (sessionCookie) {
  try {
    const session: AuthSession = JSON.parse(sessionCookie);
    const user = findUserById(session.userId);
    if (user) {
      isAuthenticated = true;
      currentUser = {
        id: user.id,
        username: user.username,
        fullName: user.full_name,
        role: user.role,
      };
    } else {
      // Invalid session - user deleted or deactivated
      Astro.cookies.delete(COOKIE_NAME, { path: "/" });
    }
  } catch (e) {
    // Invalid session
    Astro.cookies.delete(COOKIE_NAME, { path: "/" });
  }
}

// Handle logout
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");
  if (action === "logout") {
    Astro.cookies.delete(COOKIE_NAME, { path: "/" });
    return Astro.redirect("/admin");
  }
}

let rsvps = [],
  wishes = [],
  stats = { total: 0, hadir: 0, ragu: 0, tidak: 0, guestCount: 0 };

if (isAuthenticated) {
  rsvps = db.prepare("SELECT * FROM rsvps ORDER BY created_at DESC").all();
  wishes = db.prepare("SELECT * FROM wishes ORDER BY created_at DESC").all();
  stats.total = rsvps.length;
  stats.hadir = rsvps.filter((r: any) => r.attendance === "hadir").length;
  stats.ragu = rsvps.filter((r: any) => r.attendance === "ragu").length;
  stats.tidak = rsvps.filter((r: any) => r.attendance === "tidak_hadir").length;
  stats.guestCount = rsvps
    .filter((r: any) => r.attendance === "hadir")
    .reduce((sum: number, r: any) => sum + (r.guest_count || 1), 0);
}
---

<Layout title="Admin Dashboard">
  <main
    class="min-h-screen bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200"
  >
    {
      !isAuthenticated ? (
        <LoginForm client:load />
      ) : (
        <div class="flex h-screen overflow-hidden">
          {/* SIDEBAR - Auto-collapse with hover to expand */}
          <aside id="sidebar" class="group hidden w-20 flex-col border-r border-slate-200 bg-white transition-all duration-300 hover:w-64 dark:border-slate-700 dark:bg-slate-800 lg:flex">
            {/* Logo/Header */}
            <div class="border-b border-slate-200 p-6 dark:border-slate-700">
              <div class="sidebar-content overflow-hidden whitespace-nowrap opacity-0 transition-opacity duration-300 group-hover:opacity-100">
                <h1 class="font-serif text-xl font-bold italic text-slate-900 dark:text-white">
                  Wedding Admin
                </h1>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                  {currentUser.fullName || currentUser.username}
                </p>
                <span class="mt-2 inline-block rounded-full bg-blue-100 px-2 py-0.5 text-xs font-semibold text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">
                  {currentUser.role.replace("_", " ").toUpperCase()}
                </span>
              </div>
            </div>

            {/* Navigation */}
            <nav class="flex-1 space-y-1 overflow-y-auto p-4">
              <button
                id="nav-dashboard"
                class="nav-btn flex w-full items-center gap-3 rounded-lg bg-blue-50 px-4 py-3 text-left text-sm font-semibold text-blue-600 dark:bg-blue-900/20 dark:text-blue-400"
                data-tab="dashboard"
                title="Dashboard"
              >
                <CheckCircle2 className="h-5 w-5 shrink-0" />
                <span class="sidebar-content overflow-hidden whitespace-nowrap opacity-0 transition-opacity duration-300 group-hover:opacity-100">Dashboard</span>
              </button>

              <button
                id="nav-guests"
                class="nav-btn flex w-full items-center gap-3 rounded-lg px-4 py-3 text-left text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-700/50"
                data-tab="guests"
                title="Guest List"
              >
                <Users className="h-5 w-5 shrink-0" />
                <span class="sidebar-content overflow-hidden whitespace-nowrap opacity-0 transition-opacity duration-300 group-hover:opacity-100">Guest List</span>
              </button>

              <button
                id="nav-analytics"
                class="nav-btn flex w-full items-center gap-3 rounded-lg px-4 py-3 text-left text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-700/50"
                data-tab="analytics"
                title="Analytics"
              >
                <svg class="h-5 w-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span class="sidebar-content overflow-hidden whitespace-nowrap opacity-0 transition-opacity duration-300 group-hover:opacity-100">Analytics</span>
              </button>

              <button
                id="nav-qr-batch"
                class="nav-btn flex w-full items-center gap-3 rounded-lg px-4 py-3 text-left text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-700/50"
                data-tab="qr-batch"
                title="QR Batch"
              >
                <svg class="h-5 w-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                </svg>
                <span class="sidebar-content overflow-hidden whitespace-nowrap opacity-0 transition-opacity duration-300 group-hover:opacity-100">QR Batch</span>
              </button>

              {currentUser.role === "super_admin" && (
                <button
                  id="nav-users"
                  class="nav-btn flex w-full items-center gap-3 rounded-lg px-4 py-3 text-left text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-700/50"
                  data-tab="users"
                  title="User Management"
                >
                  <svg class="h-5 w-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                  <span class="sidebar-content overflow-hidden whitespace-nowrap opacity-0 transition-opacity duration-300 group-hover:opacity-100">User Management</span>
                </button>
              )}
            </nav>

            {/* Logout Button */}
            <div class="border-t border-slate-200 p-4 dark:border-slate-700">
              <form method="POST">
                <input type="hidden" name="action" value="logout" />
                <button class="flex w-full items-center gap-3 rounded-lg px-4 py-3 text-left text-sm font-medium text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20" title="Logout">
                  <LogOut className="h-5 w-5 shrink-0" />
                  <span class="sidebar-content overflow-hidden whitespace-nowrap opacity-0 transition-opacity duration-300 group-hover:opacity-100">Logout</span>
                </button>
              </form>
            </div>
          </aside>

          {/* MOBILE MENU TOGGLE */}
          <div class="fixed bottom-4 right-4 z-50 lg:hidden">
            <button
              id="mobile-menu-toggle"
              class="flex h-14 w-14 items-center justify-center rounded-full bg-blue-600 text-white shadow-lg hover:bg-blue-700"
            >
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>

          {/* MAIN CONTENT */}
          <div class="flex flex-1 flex-col overflow-hidden">
            {/* Top Bar (Mobile) */}
            <header class="border-b border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-800 lg:hidden">
              <h1 class="font-serif text-xl font-bold italic text-slate-900 dark:text-white">
                Wedding Dashboard
              </h1>
              <p class="text-xs text-slate-500 dark:text-slate-400">
                {currentUser.fullName || currentUser.username}
              </p>
            </header>

            {/* Content Area */}
            <main class="flex-1 overflow-y-auto p-6">
              {/* DASHBOARD TAB */}
              <div id="content-dashboard" class="tab-content">
                {/* STATS */}
                <div class="mb-10 grid grid-cols-2 gap-4 md:grid-cols-4 lg:gap-6">
                  <div class="rounded-2xl bg-white p-6 shadow-sm dark:bg-slate-800">
                    <div class="flex items-center gap-3 text-slate-400">
                      <>
                        <Users className="h-5 w-5" />
                        <span class="text-xs font-bold uppercase">Total Respon</span>
                      </>
                    </div>
                    <p class="mt-2 text-3xl font-bold text-slate-900 dark:text-white">
                      {stats.total}
                    </p>
                  </div>
                  <div class="rounded-2xl bg-white p-6 shadow-sm dark:bg-slate-800">
                    <div class="flex items-center gap-3 text-green-500">
                      <>
                        <CheckCircle2 className="h-5 w-5" />
                        <span class="text-xs font-bold uppercase">Hadir</span>
                      </>
                    </div>
                    <div class="mt-2 flex items-baseline gap-2">
                      <>
                        <span class="text-3xl font-bold text-slate-900 dark:text-white">
                          {stats.hadir}
                        </span>
                        <span class="text-lg font-medium text-slate-400">
                          ({stats.guestCount} Pax)
                        </span>
                      </>
                    </div>
                  </div>
                  <div class="rounded-2xl bg-white p-6 shadow-sm dark:bg-slate-800">
                    <div class="flex items-center gap-3 text-yellow-500">
                      <>
                        <HelpCircle className="h-5 w-5" />
                        <span class="text-xs font-bold uppercase">Ragu</span>
                      </>
                    </div>
                    <p class="mt-2 text-3xl font-bold text-slate-900 dark:text-white">
                      {stats.ragu}
                    </p>
                  </div>
                  <div class="rounded-2xl bg-white p-6 shadow-sm dark:bg-slate-800">
                    <div class="flex items-center gap-3 text-red-500">
                      <>
                        <XCircle className="h-5 w-5" />
                        <span class="text-xs font-bold uppercase">Tidak Hadir</span>
                      </>
                    </div>
                    <p class="mt-2 text-3xl font-bold text-slate-900 dark:text-white">
                      {stats.tidak}
                    </p>
                  </div>
                </div>

                {/* MAIN DASHBOARD */}
                <AdminDashboard
                  client:load
                  initialRsvps={rsvps}
                  initialWishes={wishes}
                  siteUrl={import.meta.env.PUBLIC_SITE_URL || Astro.site?.toString() || "https://wedding.feyaya.com"}
                />
              </div>

              {/* GUEST LIST TAB */}
              <div id="content-guests" class="tab-content hidden">
                <GuestListManager client:load />
              </div>

              {/* ANALYTICS TAB */}
              <div id="content-analytics" class="tab-content hidden">
                <GuestAnalytics client:load />
              </div>

              {/* QR BATCH TAB */}
              <div id="content-qr-batch" class="tab-content hidden">
                <BatchQRGenerator client:load siteUrl={import.meta.env.PUBLIC_SITE_URL || Astro.site?.toString() || "https://wedding.feyaya.com"} />
              </div>

              {/* USER MANAGEMENT TAB */}
              {currentUser.role === "super_admin" && (
                <div id="content-users" class="tab-content hidden">
                  <UserManagement client:load currentUserRole={currentUser.role} />
                </div>
              )}
            </main>
          </div>
        </div>
      )
    }
  </main>

  <script>
    // Navigation switching
    const navButtons = document.querySelectorAll(".nav-btn");
    const tabContents = document.querySelectorAll(".tab-content");

    navButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tabName = btn.getAttribute("data-tab");

        // Update button styles
        navButtons.forEach((b) => {
          b.classList.remove("bg-blue-50", "text-blue-600", "dark:bg-blue-900/20", "dark:text-blue-400");
          b.classList.add("text-slate-600", "hover:bg-slate-50", "dark:text-slate-400", "dark:hover:bg-slate-700/50");
        });
        btn.classList.add("bg-blue-50", "text-blue-600", "dark:bg-blue-900/20", "dark:text-blue-400");
        btn.classList.remove("text-slate-600", "hover:bg-slate-50", "dark:text-slate-400", "dark:hover:bg-slate-700/50");

        // Show/hide content
        tabContents.forEach((content) => {
          if (content.id === `content-${tabName}`) {
            content.classList.remove("hidden");
          } else {
            content.classList.add("hidden");
          }
        });
      });
    });

    // Mobile menu toggle (optional enhancement)
    const mobileMenuToggle = document.getElementById("mobile-menu-toggle");
    if (mobileMenuToggle) {
      mobileMenuToggle.addEventListener("click", () => {
        alert("Mobile menu - coming soon!");
      });
    }
  </script>
</Layout>
